# Local API Specification

This is the second version of the Local API, which is also sometimes called the "Edge API" or the "Edge Services" of the ioFabric. Only this second version will be offered in the new production release of ioFabric for Linux.

This Local API offers both standard REST API endpoints and Websocket API endpoints. While REST API standards are well-known and well-documented, the use of Websockets is still on the rise and not yet common. For Websocket specifications, we will follow the IANA standards here:

<a href="http://www.iana.org/assignments/websocket/websocket.xml" target="_new">IANA Official Websocket Registry</a>

This means that we will offer the standard closure codes, op codes, etc.

All messages passing through the Local API must be in the standard ioMessage format, which can be found in the ioMessage Specification document.

Note that the ContextData and ContentData fields of all messages must be base64 encoded when sending messages in a JSON response. All incoming messages will also have these fields base64 encoded and will need to be decoded upon arrival. No other fields should be encoded, because all other fields are capable of being transmitted directly as JSON. This allows containers to quickly examine an incoming message InfoType and InfoFormat to see if performing the base64 decoding is worthwhile.

If a message InfoFormat is actually base64, then it will be encoded again during transmission as JSON. While this is not very efficient, it is sustainable as a practice. Neither the ioFabric Local API nor the containers need to examine messages to determine the type of encoding. They both simply decode arriving messages and encode messages before sending (just the ContextData and ContentData fields).

#### Get Container Configuration

This endpoint provides the current JSON configuration string for the requesting container. Containers identify themselves by their element ID, which is mapped into the container as an environment variable.

##### Endpoint

<pre>
	http://iofabric:54321/v2/config/get
</pre>

##### Response

<pre>
	{
		"status":"okay",
		"config":"{\"property1\":\"value1\",\"property2\":\"value2\"}"
	}
</pre>

##### Querystring Parameters

<pre>
	None
</pre>

##### POST Parameters

<pre>
	{“id”:”R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ”}

	Note: The POST value is JSON and must be sent with HTTP header set as “Content-Type:application/json”
</pre>


#### Get Container Next Unread Messages

This endpoint returns a JSON array containing all of the unread messages for this container up to this point. Receiving the messages clears them from the queue so a following call to this API endpoint will not contain the same messages.

##### Endpoint

<pre>
	http://iofabric:54321/v2/messages/next
</pre>

##### Response

<pre>
	{
		"status":"okay",
		"count":2,
		"messages":
			[
				{
					"id":"ObJ5STY02PMLM4XKXM8oSuPlc7mUh5Ej",
					"tag":"",
					"groupid":"",
					"sequencenumber":1,
					"sequencetotal":1,
					"priority":0,
					"timestamp":1452214777495,
					"publisher":"R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ",
					"authid":"",
					"authgroup":"",
					"version":4,
					"chainposition":0,
					"hash":"",
					"previoushash":"",
					"nonce":"",
					"difficultytarget":0.0,
					"infotype":"text",
					"infoformat":"utf-8",
					"contextdata":"",
					"contentdata":"8943asefSDhdkljsafhasldkjhfdlk==wehj23"
				},
				{
					"id":"sd098wytfskduhdsfDSKfhjw4o8ytwesdoiuhsdf",
					"tag":"Bosch Camera 16",
					"groupid":"",
					"sequencenumber":1,
					"sequencetotal":1,
					"priority":0,
					"timestamp":1234567890123,
					"publisher":"Ayew98wtosdhFSKdjhsdfkjhkjesdhg",
					"authid":"",
					"authgroup":"",
					"version":4,
					"chainposition":0,
					"hash":"",
					"previoushash":"",
					"nonce":"",
					"difficultytarget":0.0,
					"infotype":"image/jpeg",
					"infoformat":"file/.jpg",
					"contextdata":"",
					"contentdata":"sdkjhwrtiy8wrtgSDFOiuhsrgowh4touwsdhsDFDSKJhsdkljasjklweklfjwhefiauhw98p328946982weiusfhsdkufhaskldjfslkjdhfalsjdf=serg4towhr"
				}
			]
	}
</pre>

##### Querystring Parameters

<pre>
	None
</pre>

##### POST Parameters

<pre>
	{“id”:”R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ”}

	Note: The POST value is JSON and must be sent with HTTP header set as “Content-Type:application/json”
</pre>


#### Post Message

This endpoing allows a container to post a message to the system. The message ID is generated inside the ioFabric system, so it is not passed by the container when posting the message. The timestamp is not generated by the container, either. Both of these are returned in the repsonse from this endpoint. This prevents time synchronization problems and unique identifier problems from taking place in the container, where the language, frameworks, and code quality are unknown.

##### Endpoint

<pre>
	http://iofabric:54321/v2/messages/new
</pre>

##### Response

<pre>
	{
		"status":"okay",
		"timestamp":1234567890123,
		"id":"f9y43trfdsSDFkjhdso8y4twouhsdfksjhdf2o834wyr4we"
	}
</pre>

##### Querystring Parameters

<pre>
	None
</pre>

##### POST Parameters

<pre>
	{
		"tag":"",
		"groupid":"",
		"sequencenumber":1,
		"sequencetotal":1,
		"priority":0,
		"publisher":"R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ",
		"authid":"",
		"authgroup":"",
		"version":4,
		"chainposition":0,
		"hash":"",
		"previoushash":"",
		"nonce":"",
		"difficultytarget":0.0,
		"infotype":"text",
		"infoformat":"utf-8",
		"contextdata":"",
		"contentdata":"42h3isuhsdlukhfsd==w3efakhsfdkljhafs"
	}

	Note: The POST value is JSON and must be sent with HTTP header set as “Content-Type:application/json”
</pre>


#### Get Messages From Publishers Within Timeframe

This endpoint allows a container to query for messages from any number of publishers within any timeframe. The messages will only be provided for publishers that the container is allowed to access. In other words, if a container doesn't normally receive messages from a particular publisher, then the container can try to query for messages from that publisher but it won't receive any. The message retrieval and security controls are all performed by the Message Bus module and the allowed messages are passed to the Local API to send out.

Beause of memory limitations, the Local API may only send a portion of the requested messages. The Local API will decide how many messages are appropriate to send and will return the adjusted starting and ending timeframe as illustrated in the sample response output below. The Local API will always use the starting timeframe and will adjust the ending timeframe to reflect the timestamp of the actual last message in the list.

##### Endpoint

<pre>
	http://iofabric:54321/v2/messages/query
</pre>

##### Response

<pre>
	{
		"status":"okay",
		"count":2,
		"timeframestart":1234567890123,
		"timeframeend":9876543210123,
		"messages":
			[
				{
					"id":"ObJ5STY02PMLM4XKXM8oSuPlc7mUh5Ej",
					"tag":"",
					"groupid":"",
					"sequencenumber":1,
					"sequencetotal":1,
					"priority":0,
					"timestamp":1452214777495,
					"publisher":"R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ",
					"authid":"",
					"authgroup":"",
					"version":4,
					"chainposition":0,
					"hash":"",
					"previoushash":"",
					"nonce":"",
					"difficultytarget":0.0,
					"infotype":"text",
					"infoformat":"utf-8",
					"contextdata":"",
					"contentdata":"wei8y43ipouwhefdskhufdslkjahsdf"
				},
				{
					"id":"sd098wytfskduhdsfDSKfhjw4o8ytwesdoiuhsdf",
					"tag":"Bosch Camera 16",
					"groupid":"",
					"sequencenumber":1,
					"sequencetotal":1,
					"priority":0,
					"timestamp":1234567890123,
					"publisher":"Ayew98wtosdhFSKdjhsdfkjhkjesdhg",
					"authid":"",
					"authgroup":"",
					"version":4,
					"chainposition":0,
					"hash":"",
					"previoushash":"",
					"nonce":"",
					"difficultytarget":0.0,
					"infotype":"image/jpeg",
					"infoformat":"file/.jpg",
					"contextdata":"",
					"contentdata":"sdkjhwrtiy8wrtgSDFOiuhsrgowh4touwsdhsDFDSKJhsdkljasjklweklfjwhefiauhw98p328946982weiusfhsdkufhaskldjfslkjdhfalsjdf=serg4towhr"
				}
			]
	}
</pre>

##### Querystring Parameters

<pre>
	None
</pre>

##### POST Parameters

<pre>
	{"id":”R4b2WPZRbycCzyZBz9tD7BdMWg94YDhQ”, "timeframestart":1234567890123, "timeframeend":1234567890123, "publishers":["sefhuiw4984twefsdoiuhsdf","d895y459rwdsifuhSDFKukuewf","SESD984wtsdidsiusidsufgsdfkh"]}

	Note: The POST value is JSON and must be sent with HTTP header set as “Content-Type:application/json”
</pre>


#### Get Control Websocket Connection

This endpoint opens a control Websocket connection for the container. The control commands sent over this Websocket are specified here. It is the responsibility of the container to establish this connection and ensure it is always running. If the container loses the Websocket connection, it should establish a new connection. The Local API is responsible for knowing which Websocket connection belongs to which container so that it can pass information to the appropriate recipients.

The container ID must be passed as part of the URL because otherwise it would have to be passed in the Websocket connection itself and that would make associated connections with container IDs rather difficult.

##### Endpoint

<pre>
	ws://iofabric:54321/v2/control/socket/id/34t9whefsdfDFKjhw4tiouhwef
</pre>

##### Response

<pre>
	None - the Websocket will simply be opened successfully
</pre>

##### Querystring Parameters

<pre>
	id - the container ID of the container requesting the Websocket connection (example shown here as 34t9whefsdfDFKjhw4tiouhwef)
</pre>

##### POST Parameters

<pre>
	None
</pre>

##### Transmissions From ioFabric To Container

<pre>
	Standard "Ping" message (op code 9)
	Standard "Pong" message (op code 10)
	Acknowledgement message (op code 11)
	New container configuration available (op code 12)
</pre>

##### Transmissions From Container To ioFabric

<pre>
	Standard "Ping" message (op code 9)
	Standard "Pong" message (op code 10)
	Acknowledgement message (op code 11)
</pre>


#### Get Message Websocket Connection

This endpoint opens a message Websocket connection for the container. The messages and other commands sent over this Websocket are specified here. It is the responsibility of the container to establish this connection and ensure it is always running. If the container loses the Websocket connection, it should establish a new connection. The Local API is responsible for knowing which Websocket connection belongs to which container so that it can pass information to the appropriate recipients.

The container ID must be passed as part of the URL because otherwise it would have to be passed in the Websocket connection itself and that would make associated connections with container IDs rather difficult.

##### Endpoint

<pre>
	ws://iofabric:54321/v2/message/socket/id/34t9whefsdfDFKjhw4tiouhwef
</pre>

##### Response

<pre>
	None - the Websocket will simply be opened successfully
</pre>

##### Querystring Parameters

<pre>
	id - the container ID of the container requesting the Websocket connection (example shown here as 34t9whefsdfDFKjhw4tiouhwef)
</pre>

##### POST Parameters

<pre>
	None
</pre>

##### Transmissions from ioFabric to Container

<pre>
	Standard "Ping" message (op code 9)
	Standard "Pong" message (op code 10)
	ioMessage transmission (op code 13 followed by 4 bytes indicating the total length of the message followed by the bytes of the actual ioMessage)
	ioMessage receipt transmission (op code 14 followed by 4 bytes indicating the length of the response followed by the actual bytes of the response message containing the ioMessage ID and Timestamp fields with all other fields empty)
</pre>

##### Transmissions from Container to ioFabric

<pre>
	Standard "Ping" message (op code 9)
	Standard "Pong" message (op code 10)
	Acknowledgement message (op code 11)
	ioMessage transmission (op code 13 followed by 4 bytes indicating the total length of the message followed by the bytes of the actual ioMessage)
</pre>

